name: Deploy production

on:
  push:
    branches:
      - main

env:
  GITHUB_SHA: ${{ github.sha }}
  DO_REGISTRY: 178.128.64.173
  IMAGE: sellergpt
  DROPLET_IP: ${{ secrets.DROPLET_IP }}       # Droplet public IP
  SSH_USER: root    # e.g., 'root' or your user
  SSH_KEY: ${{ secrets.SSH_PRIVATE_KEY }}     # Private key for SSH login

jobs:
  build-and-deploy:
    name: Build, push, and deploy to Droplet
    runs-on: ubuntu-latest

    steps:
      - name: Checkout main
        uses: actions/checkout@v3

      # Build Docker image
      - name: Build Docker image
        run: |
          docker build --memory=8000M -t $DO_REGISTRY/$IMAGE:$GITHUB_SHA -t $DO_REGISTRY/$IMAGE:latest -f Dockerfile .

      # Install doctl
      - name: Install doctl
        uses: digitalocean/action-doctl@v2
        with:
          token: ${{ secrets.DO_API_TOKEN }}

      # Push Docker image to DO Registry
      - name: Push Docker image to DO Registry
        run: |
          doctl registry login --expiry-seconds 1000
          docker push $DO_REGISTRY/$IMAGE:$GITHUB_SHA
          docker push $DO_REGISTRY/$IMAGE:latest

      # Deploy to Droplet via SSH
      - name: Deploy on Droplet
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ env.DROPLET_IP }}
          username: ${{ env.SSH_USER }}
          key: ${{ env.SSH_KEY }}
          script: |
            echo "Pulling latest Docker image..."
            docker pull $DO_REGISTRY/$IMAGE:latest
            docker tag $DO_REGISTRY/$IMAGE:latest $IMAGE:latest

            echo "Stopping and removing old container if exists..."
            docker compose -f /root/docker-compose.yml down || true

            echo "Starting new container..."
            docker compose -f /root/docker-compose.yml up -d

            echo "Deployment complete!"
