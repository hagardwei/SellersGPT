name: Deploy to DigitalOcean Droplet

on:
  push:
    branches:
      - main  # Trigger the action on pushes to the 'main' branch

jobs:
  deploy:
    runs-on: ubuntu-latest  # The runner environment

    steps:
    - name: Checkout code
      uses: actions/checkout@v2  # Checkout the repository code

    - name: Set up SSH keys
      run: |
        # Create SSH directory and configure the private key for authentication
        mkdir -p ~/.ssh
        echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa  # Store SSH private key from secrets
        chmod 600 ~/.ssh/id_rsa  # Set permissions for the SSH private key
        # Add the droplet's host to the known hosts to avoid SSH verification issues
        ssh-keyscan -t rsa 178.128.64.173 >> ~/.ssh/known_hosts  # Replace with your droplet's IP address

    - name: Deploy to Droplet
      run: |
        # SSH into your droplet and deploy the latest changes from Git
        ssh root@178.128.64.173 << 'EOF'
          # Step 1: Set the project directory path
          cd /root/sellerapp/SellersGPT  # <-- Here, set your droplet's project directory path
          
          # Step 2: Pull the latest changes from the 'main' branch
          git fetch origin
          git checkout main
          git pull origin main
          
          # Step 3: Install Node.js (if not already installed on droplet)
          # Check for Node.js version or install it if necessary
          if ! command -v node &> /dev/null
          then
            echo "Node.js not found, installing..."
            curl -fsSL https://deb.nodesource.com/setup_16.x | sudo -E bash -
            sudo apt-get install -y nodejs
          else
            echo "Node.js is already installed"
          fi
          
          # Step 4: Install project dependencies
          npm install  # Or use yarn if you use yarn: yarn install
          
          # Step 5: Run database migrations (PostgreSQL)
          # Example for Sequelize:
          # If you are using Sequelize for migrations:
          # npx sequelize-cli db:migrate
          
          # Or if using TypeORM (Node.js ORM for PostgreSQL):
          # npx typeorm migration:run
          
          # If using plain SQL for migrations, ensure to run your SQL scripts here:
          # psql -U postgres_user -d your_database -a -f /path/to/your/migration.sql

          # Step 6: Build and start Next.js application
          npm run build  # Build the Next.js app for production
          npm run start  # Start the Next.js app (or use PM2 for managing it)

          # Step 7: Restart services (if applicable)
          # If you are using Nginx and PM2, restart these services
          sudo systemctl restart nginx
          pm2 restart all  # Restart all PM2-managed services (if using PM2 for process management)

        EOF

    - name: Clean up SSH keys
      run: rm -rf ~/.ssh  # Clean up SSH keys after the deployment